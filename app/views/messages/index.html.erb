<main>
  <div class="main-wrapper pt-80">
    <div class="container">
      <div id="frame">
        <div id="sidepanel">
          <div id="profile">
            <div class="wrap">
              <% if current_user.profile_picture.attached? %>
                <%= image_tag url_for(current_user.profile_picture), class:"online img-responsive img-round" %>
              <% else %>
                <%= image_tag "avatar/user_default", class:"online"%>
              <% end %>
              <p><%= current_user.name %></p>
            </div>
          </div>
          <hr style="border-top: 1px solid #dc4734;">
<!--          <div id="search">-->
<!--            <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>-->
<!--            <input type="text" placeholder="Search contacts..." />-->
<!--          </div>-->
          <div id="contacts">
            <ul class=" tabs users-tabs">
              <% @conversations.each do |conversation| %>
                <%= form_tag read_message_path(id: conversation.id), id: "form-"+conversation.id.to_s, authenticity_token: true, remote: true do |f| %>
                  <li class="contact" data-chat="person1" data-toggle="tab" href="#con-<%=conversation.id%>" id="user-box-<%=conversation.id%>">
                    <div class="wrap">
                      <% op_user = conversation.opposed_user(current_user) %>
                      <% if op_user.profile_picture.attached? %>
                        <%= image_tag url_for(op_user.profile_picture)%>
                      <% else %>
                        <%= image_tag "avatar/user_default"%>
                      <% end %>
                      <div class="meta">
                        <% if conversation.inquiry_id != nil && conversation.quote_id != nil %>
                          <p class="name"><%= op_user.name  %> (Quote)</p>
                        <% elsif conversation.inquiry_id != nil %>
                          <p class="name"><%= op_user.name  %> (Inquiry)</p>
                        <% else %>
                          <p class="name"><%= op_user.name %></p>
                        <% end %>
                      </div>
                    </div>
                  </li>

                <% end %>
              <% end %>
            </ul>

          </div>
          <div id="bottom-bar">
<!--            <button id="addcontact"><i class="fa fa-user-plus fa-fw" aria-hidden="true"></i> <span>Add contact</span></button>-->
<!--            <button id="settings"><i class="fa fa-cog fa-fw" aria-hidden="true"></i> <span>Settings</span></button>-->
          </div>
        </div>

        <div class="tab-content" id="conversations-list">
          <div id="no-conversation" class="align-middle">
            <% if @conversations.blank? %>
              <div class="row">
                <div class="col-12 align-self-center justify-content-center">
                  <h2 class="goods-ready-dates-bold text-center">Your inbox is empty</h2>
                </div>
                <div class="col-12 align-self-center justify-content-center">
                  <h1 class="text-center">
                    <i class="fa fa-envelope" aria-hidden="true"></i>
                  </h1>
                </div>
                <div class="col-12 align-self-center justify-content-center text-center" id="chat-with-friends">
                  <button class="login-redirect-btn text-center" onclick="location.href='<%= friends_user_path(current_user) %>'" type="button">
                    Chat With Your Friends
                  </button>
                </div>
              </div>
            <% else %>
            <div class="row">
              <div class="col-12 align-self-center">
                <h2 class="goods-ready-dates-bold text-center">Select any user to open chat</h2>
              </div>
            </div>
            <% end %>
          </div>
          <% @conversations.each do |conversation| %>
            <% op_user = conversation.opposed_user(current_user) %>
            <div class="content <%= conversation.id === @id ? 'tab-pane active show' : "tab-pane" %>" id="con-<%=conversation.id%>" data-conversation-id="<%= conversation.id %>">
              <div class="contact-profile">
                <% if op_user.profile_picture.attached? %>
                  <%= image_tag url_for(op_user.profile_picture)%>
                <% else %>
                  <%= image_tag "avatar/user_default"%>
                <% end %>
                <% if conversation.inquiry_id != nil && conversation.quote_id != nil %>
                  <p class="name"><%= op_user.name  %> <a target="_blank" class="label label-danger" href="<%= inquiry_quote_path(inquiry_id: conversation.inquiry_id, id: conversation.quote_id) %>">Quote</a> </p>
                <% elsif conversation.inquiry_id != nil %>
                    <p class="name"><%= op_user.name  %> <a target="_blank" class="label label-primary" href="<%= inquiry_path(id: conversation.inquiry_id) %>">Inquiry</a> </p>
                <% else %>
                  <p class="name"><%= op_user.name %></p>
                <% end %>
              </div>

              <div class="messages panel-body" id="panel-body-<%=conversation.id%>">
                <div class="chat-container messages-list message-list-inner" >
                  <ul class="commentList message-list custom-scroll" style="min-height: 450px; max-height: 450px">
                    <%= render 'conversations/conversation_content', messages: conversation.messages, user: current_user %>
                  </ul>
              </div>
              <div class="message-input" style="position: relative !important;">
                <div class="wrap">
                  <form class="new_message">
                    <input name="conversation_id" type="hidden" value="<%= conversation.id %>">
                    <input name="user_id" type="hidden" value="<%= current_user.id %>">
                    <input name="body" type="text" placeholder="Write your message..." style="width: 90%;box-sizing: border-box;border: 3px solid #ccc; ;font-size: small; padding-left: 10px " />
                    <button type="submit" value="Send" class="submit" ><i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                  </form>
                </div>
              </div>
            </div>
              </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</main>


<% if @id != nil %>
<script>
  var conversations = $('#conversations-list');
  var id = <%= @id %>
  var conversation = conversations.find("[data-conversation-id='" + id + "']");
  var ul = conversation.find('.commentList');
  var abc = conversation.find('.commentList li:last');
  if (id !== 0) {
      $('#no-conversation').empty();
  }
  jQuery(ul).animate({scrollTop: $(ul).scrollTop() + jQuery(abc).offset().top + 30}, "slow");
</script>
<% end %>
